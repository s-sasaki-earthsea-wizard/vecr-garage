{% extends "base.html" %}

{% block title %}ホーム - VECR Member Manager{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="jumbotron bg-light p-5 rounded">
            <h1 class="display-4">
                <i class="fas fa-users me-3"></i>VECR Garage Member Manager
            </h1>
            <p class="lead">メンバー管理システムへようこそ</p>
            <hr class="my-4">
            <p>データベースと連携して動的にデータを表示・管理できます。</p>
            <div class="d-flex gap-2">
                <a class="btn btn-primary btn-lg" href="{{ url_for('database_view') }}">
                    <i class="fas fa-database me-2"></i>データベース管理
                </a>
                <button class="btn btn-outline-secondary btn-lg" onclick="showTableData()">
                    <i class="fas fa-table me-2"></i>テーブル一覧表示
                </button>
            </div>
        </div>
    </div>
</div>

<!-- テーブルデータ表示セクション -->
<div class="row" id="tableDataSection" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-table me-2"></i>データベーステーブル
                </h5>
            </div>
            <div class="card-body">
                <!-- テーブル選択 -->
                <div class="mb-3">
                    <label for="tableSelect" class="form-label">テーブル選択:</label>
                    <select id="tableSelect" class="form-select" onchange="loadTableData()">
                        <option value="">-- テーブルを選択してください --</option>
                        <!-- JavaScriptで動的に生成 -->
                    </select>
                </div>

                <!-- データ表示エリア -->
                <div id="dataSection" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 id="tableName" class="mb-0"></h6>
                        <div>
                            <button id="addRecordBtn" class="btn btn-sm btn-primary me-2" onclick="showAddRecordModal()">
                                <i class="fas fa-plus me-1"></i>新規レコード追加
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="refreshTableData()">
                                <i class="fas fa-sync-alt me-1"></i>更新
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table id="dataTable" class="table table-striped table-hover">
                            <thead id="tableHead" class="table-dark">
                                <!-- JavaScriptで動的に生成 -->
                            </thead>
                            <tbody id="tableBody">
                                <!-- JavaScriptで動的に生成 -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- テーブル未選択時のメッセージ -->
                <div id="noTableSelected" class="text-center py-4">
                    <i class="fas fa-arrow-up fa-2x text-muted mb-3"></i>
                    <p class="text-muted">上記のドロップダウンからテーブルを選択してください。</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 新規レコード追加モーダル -->
<div class="modal fade" id="addRecordModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">新規レコード追加</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addRecordForm">
                    <!-- JavaScriptで動的に生成 -->
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" onclick="saveRecord()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 編集モーダル -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">レコード編集</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <!-- JavaScriptで動的に生成 -->
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" onclick="updateRecord()">更新</button>
            </div>
        </div>
    </div>
</div>

<!-- 削除確認モーダル -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">削除確認</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>このレコードを削除してもよろしいですか？</p>
                <p id="deleteInfo" class="text-muted"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">削除</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentTableName = '';
let currentTableData = null;

// テーブルデータ表示の切り替え
function showTableData() {
    const section = document.getElementById('tableDataSection');
    if (section.style.display === 'none') {
        section.style.display = 'block';
        document.querySelector('button[onclick="showTableData()"]').textContent = 'テーブル一覧非表示';
        loadAvailableTables();
    } else {
        section.style.display = 'none';
        document.querySelector('button[onclick="showTableData()"]').textContent = 'テーブル一覧表示';
    }
}

// 利用可能なテーブル一覧を読み込み
function loadAvailableTables() {
    fetch('/api/db/tables')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                populateTableSelect(data.tables);
            } else {
                console.error('テーブル一覧の取得に失敗:', data.message);
            }
        })
        .catch(error => {
            console.error('テーブル一覧読み込みエラー:', error);
        });
}

// テーブル選択ドロップダウンを生成
function populateTableSelect(tables) {
    const tableSelect = document.getElementById('tableSelect');
    tableSelect.innerHTML = '<option value="">-- テーブルを選択してください --</option>';
    
    tables.forEach(table => {
        const option = document.createElement('option');
        option.value = table.name;
        option.textContent = `${table.name} (${table.record_count}件)`;
        tableSelect.appendChild(option);
    });
}

// 選択されたテーブルのデータを読み込み
function loadTableData() {
    const tableSelect = document.getElementById('tableSelect');
    const tableName = tableSelect.value;
    
    if (!tableName) {
        document.getElementById('dataSection').style.display = 'none';
        document.getElementById('noTableSelected').style.display = 'block';
        return;
    }
    
    currentTableName = tableName;
    
    // テーブルの詳細データを取得
    fetch(`/api/db/table/${tableName}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentTableData = data.data;
                displayTableData(data.data);
            } else {
                console.error('テーブルデータの取得に失敗:', data.message);
            }
        })
        .catch(error => {
            console.error('テーブルデータ読み込みエラー:', error);
        });
}

// テーブルデータの表示
function displayTableData(tableData) {
    const dataSection = document.getElementById('dataSection');
    const noTableSelected = document.getElementById('noTableSelected');
    const tableName = document.getElementById('tableName');
    const tableHead = document.getElementById('tableHead');
    const tableBody = document.getElementById('tableBody');
    
    tableName.textContent = tableData.table_name || 'テーブル';
    dataSection.style.display = 'block';
    noTableSelected.style.display = 'none';
    
    // ヘッダー行の生成
    if (tableData.columns && tableData.columns.length > 0) {
        let headerHtml = '<tr>';
        tableData.columns.forEach(column => {
            headerHtml += `<th>${column.name}</th>`;
        });
        headerHtml += '<th>操作</th></tr>';
        tableHead.innerHTML = headerHtml;
    }
    
    // データ行の生成
    if (tableData.data && tableData.data.length > 0) {
        let bodyHtml = '';
        tableData.data.forEach((row, index) => {
            bodyHtml += '<tr>';
            tableData.columns.forEach(column => {
                const value = row[column.name];
                bodyHtml += `<td>${formatCellValue(value, column.type)}</td>`;
            });
            bodyHtml += `
                <td>
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editRecord('${tableData.table_name}', ${index})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteRecord('${tableData.table_name}', ${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>`;
        });
        tableBody.innerHTML = bodyHtml;
    } else {
        tableBody.innerHTML = '<tr><td colspan="100%" class="text-center text-muted">データがありません</td></tr>';
    }
}

// セル値のフォーマット
function formatCellValue(value, columnType) {
    if (value === null) {
        return '<span class="text-muted fst-italic">NULL</span>';
    }
    
    if (columnType === 'timestamp with time zone' || columnType === 'timestamp without time zone') {
        return `<span class="text-info">${value}</span>`;
    } else if (columnType === 'uuid') {
        return `<code class="text-primary">${value}</code>`;
    } else if (columnType === 'integer' || columnType === 'bigint') {
        return `<span class="text-success">${value}</span>`;
    } else if (columnType === 'text' && value.length > 50) {
        return `<span title="${value}">${value.substring(0, 50)}...</span>`;
    }
    
    return value;
}

// テーブルデータの更新
function refreshTableData() {
    if (currentTableName) {
        loadTableData();
    }
}

// 新規レコード追加モーダルの表示
function showAddRecordModal() {
    if (!currentTableData) return;
    
    const modal = new bootstrap.Modal(document.getElementById('addRecordModal'));
    const form = document.getElementById('addRecordForm');
    
    // フォームを生成
    form.innerHTML = generateFormFields(currentTableData.columns, {});
    
    modal.show();
}

// 編集モーダルの表示
function editRecord(tableName, index) {
    if (!currentTableData || !currentTableData.data[index]) return;
    
    const modal = new bootstrap.Modal(document.getElementById('editModal'));
    const form = document.getElementById('editForm');
    const record = currentTableData.data[index];
    
    // フォームを生成
    form.innerHTML = generateFormFields(currentTableData.columns, record);
    
    modal.show();
}

// 削除確認モーダルの表示
function deleteRecord(tableName, index) {
    if (!currentTableData || !currentTableData.data[index]) return;
    
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    const record = currentTableData.data[index];
    
    // 削除情報を表示
    const deleteInfo = document.getElementById('deleteInfo');
    let infoText = '';
    
    // 主要な列の値を表示
    if (record.member_name) infoText += `名前: ${record.member_name} `;
    if (record.member_id) infoText += `ID: ${record.member_id} `;
    if (record.relationship_type) infoText += `関係: ${record.relationship_type} `;
    
    deleteInfo.textContent = infoText || 'レコード情報がありません';
    
    modal.show();
}

// フォームフィールドの生成
function generateFormFields(columns, record) {
    let formHtml = '';
    
    // 新規レコード登録時に除外するフィールド（バックエンド/DB側で自動生成）
    const excludeFields = [
        'uuid', 'member_id', 'id', 'created_at', 'updated_at',
        'member_uuid', 'profile_uuid', 'profile_id', 'relationship_id'
    ];
    
    columns.forEach(column => {
        // 新規レコード登録時は除外フィールドをスキップ
        if (!record.uuid && excludeFields.includes(column.name)) {
            return;
        }
        
        const value = record[column.name] || '';
        const isRequired = column.nullable === 'NO';
        
        formHtml += `
            <div class="mb-3">
                <label for="${column.name}" class="form-label">
                    ${column.name}
                    ${isRequired ? '<span class="text-danger">*</span>' : ''}
                </label>
        `;
        
        if (column.type === 'text' || column.type === 'character varying') {
            formHtml += `
                <textarea class="form-control" id="${column.name}" name="${column.name}" 
                          rows="3" ${isRequired ? 'required' : ''} 
                          onblur="validateField('${column.name}', this.value)"
                          oninput="clearValidationError('${column.name}')">${value}</textarea>
            `;
        } else if (column.type === 'integer' || column.type === 'bigint') {
            formHtml += `
                <input type="number" class="form-control" id="${column.name}" name="${column.name}" 
                       value="${value}" ${isRequired ? 'required' : ''}
                       onblur="validateField('${column.name}', this.value)"
                       oninput="clearValidationError('${column.name}')">
            `;
        } else if (column.type === 'uuid') {
            formHtml += `
                <input type="text" class="form-control" id="${column.name}" name="${column.name}" 
                       value="${value}" pattern="[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}" 
                       placeholder="UUID形式で入力" ${isRequired ? 'required' : ''}
                       onblur="validateField('${column.name}', this.value)"
                       oninput="clearValidationError('${column.name}')">
            `;
        } else {
            formHtml += `
                <input type="text" class="form-control" id="${column.name}" name="${column.name}" 
                       value="${value}" ${isRequired ? 'required' : ''}
                       onblur="validateField('${column.name}', this.value)"
                       oninput="clearValidationError('${column.name}')">
            `;
        }
        
        formHtml += `
                <div class="form-text">${getColumnDescription(column.name)}</div>
                <div id="${column.name}-error" class="invalid-feedback" style="display: none;"></div>
            </div>
        `;
    });
    
    return formHtml;
}

// 列の説明を取得（簡易版）
function getColumnDescription(columnName) {
    const descriptions = {
        'member_id': 'メンバーの一意識別子',
        'member_uuid': 'メンバーのUUID',
        'member_name': 'メンバーの表示名',
        'bio': '自己紹介・プロフィール文',
        'llm_model': '使用するLLMモデル名',
        'custom_prompt': 'カスタムプロンプト設定',
        'relationship_type': '関係性の種類（mentor、mentee、peer等）',
        'name_suffix': '呼び方（さん、くん等）'
    };
    return descriptions[columnName] || '列の説明';
}

// レコード保存
function saveRecord() {
    // 全フィールドのバリデーションを実行
    if (!validateAllFields()) {
        alert('入力内容にエラーがあります。エラーメッセージを確認してください。');
        return;
    }
    
    // 新規レコードの保存ロジック
    console.log('新規レコード保存機能は今後の実装予定です');
    alert('新規レコード保存機能は今後の実装予定です');
    
    // モーダルを閉じる
    const modal = bootstrap.Modal.getInstance(document.getElementById('addRecordModal'));
    modal.hide();
}

// レコード更新
function updateRecord() {
    // レコードの更新ロジック
    console.log('レコード更新機能は今後の実装予定です');
    alert('レコード更新機能は今後の実装予定です');
    
    // モーダルを閉じる
    const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
    modal.hide();
}

// 削除確認
function confirmDelete() {
    // レコードの削除ロジック
    console.log('レコード削除機能は今後の実装予定です');
    alert('レコード削除機能は今後の実装予定です');
    
    // モーダルを閉じる
    const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
    modal.hide();
}

// フィールドバリデーション（バリデーションルールは今後修正する可能性あり）
// 修正が必要な場合は、この関数内のロジックと各フィールドの個別バリデーション関数を更新してください
function validateField(fieldName, value) {
    const errorElement = document.getElementById(`${fieldName}-error`);
    const inputElement = document.getElementById(fieldName);
    
    // エラーをクリア
    clearValidationError(fieldName);
    
    // 必須チェック
    if (isFieldRequired(fieldName) && (!value || value.trim() === '')) {
        showValidationError(fieldName, 'このフィールドは必須です');
        return false;
    }
    
    // 空の値の場合はバリデーションをスキップ
    if (!value || value.trim() === '') {
        return true;
    }
    
    // フィールド別のバリデーション
    let isValid = true;
    let errorMessage = '';
    
    switch (fieldName) {
        case 'member_name':
            isValid = validateMemberName(value);
            if (!isValid) errorMessage = 'メンバー名は1-50文字で入力してください';
            break;
        case 'bio':
            isValid = validateBio(value);
            if (!isValid) errorMessage = '自己紹介は10-1000文字で入力してください';
            break;
        case 'llm_model':
            isValid = validateLlmModel(value);
            if (!isValid) errorMessage = 'LLMモデル名は1-50文字で入力してください';
            break;
        case 'custom_prompt':
            isValid = validateCustomPrompt(value);
            if (!isValid) errorMessage = 'カスタムプロンプトは最大5000文字で入力してください';
            break;
        case 'relationship_type':
            isValid = validateRelationshipType(value);
            if (!isValid) errorMessage = '関係性の種類を選択してください';
            break;
        case 'name_suffix':
            isValid = validateNameSuffix(value);
            if (!isValid) errorMessage = '呼び方は1-50文字で入力してください';
            break;
    }
    
    if (!isValid && errorMessage) {
        showValidationError(fieldName, errorMessage);
    }
    
    return isValid;
}

// フィールドが必須かどうかを判定
function isFieldRequired(fieldName) {
    const inputElement = document.getElementById(fieldName);
    return inputElement && inputElement.hasAttribute('required');
}

// バリデーションエラーを表示
function showValidationError(fieldName, message) {
    const errorElement = document.getElementById(`${fieldName}-error`);
    const inputElement = document.getElementById(fieldName);
    
    if (errorElement && inputElement) {
        errorElement.textContent = message;
        errorElement.style.display = 'block';
        inputElement.classList.add('is-invalid');
    }
}

// バリデーションエラーをクリア
function clearValidationError(fieldName) {
    const errorElement = document.getElementById(`${fieldName}-error`);
    const inputElement = document.getElementById(fieldName);
    
    if (errorElement && inputElement) {
        errorElement.style.display = 'none';
        inputElement.classList.remove('is-invalid');
    }
}

// メンバー名のバリデーション
function validateMemberName(value) {
    const trimmedValue = value.trim();
    if (trimmedValue.length < 1 || trimmedValue.length > 50) {
        return false;
    }
    // 特殊文字の過度な使用を制限
    const specialCharCount = (trimmedValue.match(/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/g) || []).length;
    if (specialCharCount > trimmedValue.length * 0.3) {
        return false;
    }
    return true;
}

// 自己紹介のバリデーション
function validateBio(value) {
    const trimmedValue = value.trim();
    if (trimmedValue.length < 10 || trimmedValue.length > 1000) {
        return false;
    }
    return true;
}

// LLMモデルのバリデーション
function validateLlmModel(value) {
    const trimmedValue = value.trim();
    if (trimmedValue.length < 1 || trimmedValue.length > 50) {
        return false;
    }
    // 有効なLLMモデル名の形式チェック
    const validModels = ['gpt-4', 'gpt-3.5-turbo', 'claude-3', 'claude-2', 'gemini-pro', 'llama-2'];
    if (validModels.some(model => trimmedValue.toLowerCase().includes(model))) {
        return true;
    }
    // カスタムモデル名も許可（基本的な形式チェック）
    return /^[a-zA-Z0-9\-_\.]+$/.test(trimmedValue);
}

// カスタムプロンプトのバリデーション
function validateCustomPrompt(value) {
    const trimmedValue = value.trim();
    if (trimmedValue.length > 5000) {
        return false;
    }
    return true;
}

// 関係性の種類のバリデーション
function validateRelationshipType(value) {
    const trimmedValue = value.trim();
    const validTypes = ['mentor', 'mentee', 'peer', 'colleague', 'friend', 'family'];
    return validTypes.includes(trimmedValue.toLowerCase());
}

// 呼び方のバリデーション
function validateNameSuffix(value) {
    const trimmedValue = value.trim();
    if (trimmedValue.length < 1 || trimmedValue.length > 50) {
        return false;
    }
    // 日本語の敬語表現の妥当性チェック
    const validSuffixes = ['さん', 'くん', 'ちゃん', '様', '氏', '先生', '先輩'];
    if (validSuffixes.some(suffix => trimmedValue.includes(suffix))) {
        return true;
    }
    // カスタム呼び方も許可
    return true;
}

// 全フィールドのバリデーション
function validateAllFields() {
    let isValid = true;
    const form = document.getElementById('addRecordForm');
    const inputs = form.querySelectorAll('input, textarea');
    
    inputs.forEach(input => {
        if (!validateField(input.name, input.value)) {
            isValid = false;
        }
    });
    
    return isValid;
}

// ページ読み込み時の初期化
document.addEventListener('DOMContentLoaded', function() {
    // 必要に応じて初期化処理を追加
});
</script>
{% endblock %}