{% extends "base.html" %}

{% block title %}{{ table_name }} - VECR Member Manager{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- ヘッダー -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ url_for('tables_view') }}">テーブル一覧</a></li>
                        <li class="breadcrumb-item active">{{ table_name }}</li>
                    </ol>
                </nav>
                <h1 class="h3">
                    <i class="fas fa-table me-2"></i>{{ table_name }}
                </h1>
            </div>
            <div>
                <button class="btn btn-primary" onclick="refreshTableData()">
                    <i class="fas fa-sync-alt me-1"></i>更新
                </button>
                <a href="{{ url_for('tables_view') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-list me-1"></i>テーブル一覧
                </a>
            </div>
        </div>

        <!-- テーブル情報カード -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>テーブル情報
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <strong>テーブル名:</strong> <code>{{ table_name }}</code>
                    </div>
                    <div class="col-md-3">
                        <strong>総レコード数:</strong> 
                        <span class="badge bg-info">{{ table_data.total_count }} 件</span>
                    </div>
                    <div class="col-md-3">
                        <strong>列数:</strong> 
                        <span class="badge bg-secondary">{{ table_data.columns|length }} 列</span>
                    </div>
                    <div class="col-md-3">
                        <strong>表示件数:</strong> 
                        <span class="badge bg-success">{{ table_data.data|length }} 件</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 列情報カード -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-columns me-2"></i>列情報（スキーマ）
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>列名</th>
                                <th>データ型</th>
                                <th>NULL許可</th>
                                <th>説明</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for column in table_data.columns %}
                            <tr>
                                <td>
                                    <code>{{ column.name }}</code>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ column.type }}</span>
                                </td>
                                <td>
                                    {% if column.nullable == 'YES' %}
                                        <span class="badge bg-success">許可</span>
                                    {% else %}
                                        <span class="badge bg-danger">禁止</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ column.name | get_column_description }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- データ表示カード -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-database me-2"></i>データ内容
                    {% if table_data.data|length > 0 %}
                        <span class="badge bg-primary ms-2">{{ table_data.data|length }} 件表示中</span>
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                {% if table_data.data and table_data.data|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    {% for column in table_data.columns %}
                                    <th>{{ column.name }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in table_data.data %}
                                <tr>
                                    {% for column in table_data.columns %}
                                    <td>
                                        {% set value = row[column.name] %}
                                        {% if value is none %}
                                            <span class="text-muted fst-italic">NULL</span>
                                        {% elif column.type == 'timestamp with time zone' or column.type == 'timestamp without time zone' %}
                                            <span class="text-info">{{ value }}</span>
                                        {% elif column.type == 'uuid' %}
                                            <code class="text-primary">{{ value }}</code>
                                        {% elif column.type == 'integer' or column.type == 'bigint' %}
                                            <span class="text-success">{{ value }}</span>
                                        {% elif column.type == 'text' and value|length > 50 %}
                                            <span title="{{ value }}">{{ value[:50] }}...</span>
                                        {% else %}
                                            {{ value }}
                                        {% endif %}
                                    </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    {% if table_data.total_count > table_data.data|length %}
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i>
                        表示件数が制限されています。全 {{ table_data.total_count }} 件中 {{ table_data.data|length }} 件を表示中です。
                    </div>
                    {% endif %}
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5>データがありません</h5>
                        <p class="text-muted">このテーブルにはまだレコードが登録されていません。</p>
                        <div class="mt-3">
                            <button class="btn btn-primary" onclick="showAddRecordForm()">
                                <i class="fas fa-plus me-1"></i>サンプルデータを追加
                            </button>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- サンプルデータ追加モーダル -->
<div class="modal fade" id="addSampleDataModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>サンプルデータ追加
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>このテーブルにサンプルデータを追加しますか？</p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>注意:</strong> サンプルデータは開発・テスト目的でのみ使用してください。
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" onclick="addSampleData()">
                    <i class="fas fa-plus me-1"></i>サンプルデータを追加
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// テーブルデータの更新
function refreshTableData() {
    location.reload();
}

// サンプルデータ追加フォームの表示
function showAddRecordForm() {
    const modal = new bootstrap.Modal(document.getElementById('addSampleDataModal'));
    modal.show();
}

// サンプルデータの追加
function addSampleData() {
    // ここでサンプルデータ追加のAPIを呼び出す
    console.log('サンプルデータ追加機能は今後の実装予定です');
    
    // モーダルを閉じる
    const modal = bootstrap.Modal.getInstance(document.getElementById('addSampleDataModal'));
    modal.hide();
    
    // 成功メッセージを表示
    alert('サンプルデータ追加機能は今後の実装予定です');
}

// ページ読み込み時の初期化
document.addEventListener('DOMContentLoaded', function() {
    // 必要に応じて初期化処理を追加
});
</script>
{% endblock %}
